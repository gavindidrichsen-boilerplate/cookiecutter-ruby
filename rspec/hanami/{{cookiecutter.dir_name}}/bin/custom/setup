#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
#set -vx

__dir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

pre_setup(){
	# {{cookiecutter.hanami_application}} part 1: append to top-level Gemfile
	if ! grep -q 'gem "hanami"' ${APPLICATION_ROOT}/Gemfile; then
	cat <<-EOF >> ${APPLICATION_ROOT}/Gemfile

		# hanami
		gem "hanami"
		EOF
	fi
}

post_setup(){
	(
		cd ${APPLICATION_ROOT}

		# {{cookiecutter.hanami_application}} part 2: setup hanami application framework
		if [[ ! -d {{cookiecutter.hanami_application}} ]]; then 
			bundle exec hanami new {{cookiecutter.hanami_application}} --database=sqlite --application-name=web --test=rspec
		fi

		# ensure rspec result file exists to prevent intermittent errors from occurring
		mkdir -p {{cookiecutter.hanami_application}}/tmp
		touch {{cookiecutter.hanami_application}}/tmp/rspec_guard_result

		# copy all setup code to {{cookiecutter.hanami_application}} 
		cp -R bin {{cookiecutter.hanami_application}}/. && rm -rf {{cookiecutter.hanami_application}}/bin/custom
		cp .envrc {{cookiecutter.hanami_application}}/. 
		cp .ruby-version {{cookiecutter.hanami_application}}/. 

		# remove the .git from the new {{cookiecutter.hanami_application}} application
		rm -rf {{cookiecutter.hanami_application}}/.git

		# append _core gitgnore patterns
		if ! grep -q '# _core ignore' {{cookiecutter.hanami_application}}/.gitignore; then
			echo >> {{cookiecutter.hanami_application}}/.gitignore 
			echo >> {{cookiecutter.hanami_application}}/.gitignore 
			cat .gitignore >> {{cookiecutter.hanami_application}}/.gitignore
		fi

		# append more gems to the new {{cookiecutter.hanami_application}} Gemfile
		if ! grep -q '# Gemfile EXTRAS' {{cookiecutter.hanami_application}}/Gemfile; then
			cat ${APPLICATION_ROOT}/bin/custom/.Gemfile >> {{cookiecutter.hanami_application}}/Gemfile
		fi

		# append more gems to the new {{cookiecutter.hanami_application}} Gemfile
		if [[ ! -f {{cookiecutter.hanami_application}}/Guardfile ]]; then 
			cp ${APPLICATION_ROOT}/bin/custom/.Guardfile {{cookiecutter.hanami_application}}/Guardfile
		fi
	)
}

"${@}"
